# Gomoku
  
Проект в котором необходимо реализовать игру Gomoku. В качестве противника должен выступать AI на основе алгоритма MiniMax.

В проекте присутствует два режима PvP и PvC. 

![DemoMenu](https://github.com/MixFon/Gomoku/blob/master/gifs/DemoMenu.gif "Демострация меню")


![DemoPvC](https://github.com/MixFon/Gomoku/blob/master/gifs/DemoPvC.gif "Демонстрация игры с ИИ")

## Правила игры

### Победа
Для победы необходимо выставить 5 камней или произвести 5 захватов камней противника. После выставления 5 камней игра сразу не заканчивается, ход передается противнику, для предоставления ему возможности сделать захват. Поэтому противник может выиграть по захватам, тем саммым перелоив ход игры.

![Win](https://github.com/MixFon/Gomoku/blob/master/gifs/Win.gif "Показ победы")

### Открытая тройка
Открытая тройка это три камня идущих подряд, и не закрытые с обоих краев камнями противника. Если противник вовремя не заблокирует открытую тройку, то следующими ходами будут выставленны четверка, которая не блокируется, а затем пятерка, которая приведет к победе.

![FreeThree](https://github.com/MixFon/Gomoku/blob/master/gifs/FreeThree.gif "Выставление свободной тройки")

### Двойная тройка
Двойная тройка - запрезенная комбинация, при которой одним ходом выставляется сразу две открытые тройки. Двойную тройку невозможно заблокировать, поэтому она считается запрященным ходом. 

![DoubleThree](https://github.com/MixFon/Gomoku/blob/master/gifs/DoubleThree.gif "Возможные варианты двойной тройки")

### Захват противника
Вы можете удалить пару камней противника с доски, окружив его камнями. Это правило добавляет условие победы, если вам удастся захватить пять пар камней вашего противника, вы выиграете игру. Можно переходить в захват не теряя при этом пары.

![Capture](https://github.com/MixFon/Gomoku/blob/master/gifs/Capture.gif "Захват")

## Алгоритм

### MiniMax

В проекте используется алгорим MiniMax. ИИ создает дерево возможных решений и выбирает лучший ход в соответствии с этим деревом. На каждом уровне рекурсии алгорим выбирает наилучшый вес для текущего камня (при ходе черных выбирает наилучий вес для черных, при ходе белых выбирает наилучший ход для белых) тем самым имитируя просчет ходов наперед. Вес расчитывается с помощью эвристики.

Одним из главных критериев алгоритма должна быть скорость расчета следующего хода. Время на вычисления дальнейшего хода не должно превышать 0.5 секунды. Поэтому в рамках оптимицации использовалось многопоточность. Стартовые точки отправляются в алгорим MiniMax в отдельной асинхронной очереди DispatchQueue. Так же для оптимицации использовался MiniMax с альфа-бетта отсечением.

### Доска

Для хранения информации о расположении камней и их весов используется квадратная матрица размерности 19x19. Каждая ячейка которой представлена в виде 16-ти битного беззнакового числа (UInt16), правые 8 бит которого используются для хранения веса черных камней, левые 8 бит для хранения веса белых камней. Белым камням соответствет число 0x100 (8-й бит спарава установлен в 1 остальные нули), черным камням соответствует число 0x1 (1-й бит справа установлен в 1, остальные нули).
- white  - 0x100
- black  - 0x1
- weight - любое число отличное от 0x100 и 0x1

Таким образом каждая ячейка может хранить в себе одновременно два веса или быть занятой одним из камней.

![white_black_octets](https://github.com/MixFon/Gomoku/blob/master/gifs/white_black_octets.jpg "Октеты для белых и черных камней")

Ниже показано отображение весов на доске.

![3KI1vYwqbfg](https://github.com/MixFon/Gomoku/blob/master/gifs/3KI1vYwqbfg.jpg "Отображение весов каждого из камней")
![yO7SOXOYrbc](https://github.com/MixFon/Gomoku/blob/master/gifs/yO7SOXOYrbc.jpg "Отображение весов каждого из камней")

### Эвристика и установка весов

Самая сложная часть проекта это определение эврестической функции и установлка весо. Потому что благодаря им ИИ ведет тебя тем или иным образом. При установке камня происходит расчет весов для обоих камней вокруг установленной точки на расстоянии 2-х ячейек от установленной. Одновременно с расчетом весов определятеся наилучший (наибольший) вес для каждого камня. И при выборе точки для дальнейшего хода эти точки расчитываются первыми.

На рисунке ниже вес высчитывается и устанавливатеся в поле красного цвета. Чем ближе следующий ход к победе, тем выше для него устанавливается вес.

Самым максимальным приоритетом (10) будут обладать те, которые продолжают последовательность из 4-х уже установленных камней. Так же высоким приоритетом (9) обладают те, которые продолжают открытую тройку, в этом случае победа будет через несколько ходов. Низкими приоритетами обладают камни, закрытые с одной стороны камнем противника, такие позиции легче всего заблокировать.

Самым низким приоритетом (2) обладает последовательность в которй два противоположных камня стоят радом. Если поставим камень радом со своим, то следующим ходом противник сможет захватить оба наших камня.  

Так же низким приоритетом (3) обладают позиции, которые находяится между двуня камнями противника и длина коследовательности своих камней не превышает 4. (например: xooo.x или xo.ox или xo.oox и тд. где x - это камень противника, o - наш камень, . -  позиция в которой ведется расчет веса.) Установка камня в подобные позиции не приведет к победе. 

![weights](https://github.com/MixFon/Gomoku/blob/master/gifs/weights.jpg "Распределение весов")
